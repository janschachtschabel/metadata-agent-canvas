<div class="canvas-container">
  <!-- Header with User Info (for integration modes) -->
  <div class="canvas-header" *ngIf="integrationMode.isBrowserExtension() || integrationMode.isBookmarklet()">
    <div class="header-left">
      <span class="mode-badge edu-badge edu-badge-primary">
        {{ integrationMode.getModeDisplayName() }}
      </span>
      <span class="user-info">
        <span [class.guest-badge]="!integrationMode.isLoggedIn()" 
              [class.user-badge]="integrationMode.isLoggedIn()"
              class="edu-badge"
              [class.edu-badge-secondary]="!integrationMode.isLoggedIn()"
              [class.edu-badge-success]="integrationMode.isLoggedIn()">
          {{ integrationMode.isLoggedIn() ? '👤' : '👥' }}
          {{ integrationMode.getUserInfo().username }}
        </span>
        <span class="edu-badge edu-badge-secondary" *ngIf="integrationMode.getUserInfo().systemName">
          {{ integrationMode.getUserInfo().systemName }}
        </span>
      </span>
    </div>
    <button class="btn-close" (click)="closeCanvas()" title="Schließen">×</button>
  </div>

  <!-- Input Section -->
  <div class="input-section">
    <textarea
      class="text-input"
      [(ngModel)]="userText"
      placeholder="Beschreiben Sie die Ressource, die Sie erschließen möchten..."
      rows="4"
      [disabled]="state.isExtracting"
    ></textarea>
      
    <div class="header-actions">
      <button 
        class="btn-primary"
        (click)="startExtraction()"
        [disabled]="state.isExtracting || !userText.trim()"
      >
        <span *ngIf="!state.isExtracting">🚀 Extraktion starten</span>
        <span *ngIf="state.isExtracting">⏳ Extrahiere...</span>
      </button>
      
      <button 
        class="btn-secondary"
        (click)="reset()"
        [disabled]="state.isExtracting"
      >
        🔄 Zurücksetzen
      </button>
    </div>
  </div>

  <!-- Compact Status Bar: Content Type + Progress -->
  <div *ngIf="state.totalFields > 0" class="compact-status-bar">
    <!-- Left: Content Type -->
    <div class="content-type-section">
      <span class="content-type-label">
        <span 
          *ngIf="getContentTypeIcon()" 
          class="content-type-icon"
          [title]="getContentTypeTooltip()"
        >
          {{ getContentTypeIcon() }}
        </span>
        {{ getContentTypeLabel() }}
      </span>
      <button 
        class="btn-change-content-type"
        (click)="changeContentType()"
        [disabled]="state.isExtracting"
        title="Inhaltsart ändern"
      >
        ✏️ ÄNDERN
      </button>
    </div>

    <!-- Right: Progress Info -->
    <div class="progress-section-compact">
      <div class="field-stats">
        <span class="stat-item total">
          Felder: {{ state.filledFields }}/{{ state.totalFields }} ({{ getProgressPercentage() }}%)
        </span>
        <span class="stat-separator">|</span>
        <span class="stat-item">
          Pflicht: {{ getRequiredFieldsStatus().filled }}/{{ getRequiredFieldsStatus().total }}
        </span>
        <span class="progress-emoji">{{ getProgressEmoji() }}</span>
      </div>
      <div class="progress-bar-compact">
        <div 
          class="progress-fill" 
          [style.width.%]="state.extractionProgress"
        ></div>
      </div>
    </div>

    <!-- Content Type Dropdown -->
    <div *ngIf="showContentTypeDropdown" class="content-type-dropdown">
      <div class="dropdown-overlay" (click)="closeContentTypeDropdown()"></div>
      <div class="dropdown-menu">
        <div class="dropdown-header">
          <span>Inhaltsart wählen</span>
          <button class="btn-close" (click)="closeContentTypeDropdown()">&times;</button>
        </div>
        <div class="dropdown-options">
          <button 
            *ngFor="let option of contentTypeOptions"
            class="dropdown-option"
            [class.active]="getContentTypeLabel() === option.label"
            (click)="selectContentType(option)"
          >
            <span class="option-label">{{ option.label }}</span>
            <span *ngIf="getContentTypeLabel() === option.label" class="option-checkmark">✓</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Canvas Content Area -->
  <div class="canvas-content" *ngIf="state.fieldGroups.length > 0">
    
    <!-- All Field Groups (in schema order) -->
    <div *ngFor="let group of state.fieldGroups; trackBy: trackByGroupId" class="field-group">
      <div class="group-header">
        <h3>📋 {{ group.label }}</h3>
        <div class="group-badges">
          <span class="group-badge schema-badge">{{ group.schemaName }}</span>
          <span class="group-badge count-badge">{{ getFilledFieldsCount(group) }} / {{ group.fields.length }}</span>
          <span class="badge-text">Felder erkannt</span>
        </div>
      </div>
      <div class="group-fields">
        <app-canvas-field
          *ngFor="let field of group.fields; trackBy: trackByFieldId"
          [field]="field"
          (fieldChange)="onFieldChange($event)"
        ></app-canvas-field>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="state.fieldGroups.length === 0" class="empty-state">
    <div class="empty-state-content">
      <div class="empty-icon">📝</div>
      <h3>Bereit für die Extraktion</h3>
      <p>Geben Sie eine Beschreibung ein und klicken Sie auf "Extraktion starten"</p>
    </div>
  </div>

  <!-- Footer Section -->
  <div class="canvas-footer" *ngIf="state.totalFields > 0">
    <div class="footer-info">
      <span>
        <strong>{{ state.filledFields }}</strong> von <strong>{{ state.totalFields }}</strong> Feldern gefüllt
      </span>
      <div class="provider-info">{{ llmProvider }} ({{ llmModel }})</div>
    </div>
    <div class="footer-actions" [class.multi-button]="integrationMode.isBookmarklet() || integrationMode.isStandalone()">
      <!-- Bookmarklet Mode: Beide Buttons -->
      <ng-container *ngIf="integrationMode.isBookmarklet()">
        <button 
          class="btn-success btn-large edu-btn edu-btn-primary"
          (click)="submitAsGuest()"
          [disabled]="!allRequiredFieldsFilled() || isSubmitting"
          title="Als Gast zur Prüfung einreichen"
        >
          <span *ngIf="!isSubmitting && allRequiredFieldsFilled()">📮 Vorschlag einreichen</span>
          <span *ngIf="isSubmitting">⏳ Wird eingereicht...</span>
          <span *ngIf="!allRequiredFieldsFilled()">⚠️ Pflichtfelder ({{ getRequiredFieldsStatus().filled }}/{{ getRequiredFieldsStatus().total }})</span>
        </button>
        
        <button 
          class="btn-secondary btn-large edu-btn edu-btn-outline"
          (click)="downloadJson()"
          [disabled]="!allRequiredFieldsFilled()"
          title="Als JSON-Datei herunterladen"
        >
          <span *ngIf="allRequiredFieldsFilled()">💾 JSON herunterladen</span>
          <span *ngIf="!allRequiredFieldsFilled()">⚠️ Pflichtfelder fehlen</span>
        </button>
      </ng-container>
      
      <!-- Standalone: Beide Buttons (wie Bookmarklet) -->
      <ng-container *ngIf="integrationMode.isStandalone()">
        <button 
          class="btn-success btn-large edu-btn edu-btn-primary"
          (click)="submitAsGuest()"
          [disabled]="!allRequiredFieldsFilled() || isSubmitting"
          title="Als Gast zur Prüfung einreichen"
        >
          <span *ngIf="!isSubmitting && allRequiredFieldsFilled()">📮 Vorschlag einreichen</span>
          <span *ngIf="isSubmitting">⏳ Wird eingereicht...</span>
          <span *ngIf="!allRequiredFieldsFilled()">⚠️ Pflichtfelder ({{ getRequiredFieldsStatus().filled }}/{{ getRequiredFieldsStatus().total }})</span>
        </button>
        
        <button 
          class="btn-secondary btn-large edu-btn edu-btn-outline"
          (click)="downloadJson()"
          [disabled]="!allRequiredFieldsFilled()"
          title="Als JSON-Datei herunterladen"
        >
          <span *ngIf="allRequiredFieldsFilled()">💾 JSON herunterladen</span>
          <span *ngIf="!allRequiredFieldsFilled()">⚠️ Pflichtfelder fehlen</span>
        </button>
      </ng-container>
      
      <!-- Browser Extension: Ein Button -->
      <button 
        *ngIf="integrationMode.isBrowserExtension()"
        class="btn-success btn-large edu-btn edu-btn-primary edu-btn-block"
        (click)="submitAsGuest()"
        [disabled]="!allRequiredFieldsFilled() || isSubmitting"
        [title]="!allRequiredFieldsFilled() ? 'Bitte füllen Sie alle Pflichtfelder aus' : 'An Browser-Plugin senden'"
      >
        <span *ngIf="!isSubmitting && allRequiredFieldsFilled()">💾 An Plugin senden</span>
        <span *ngIf="isSubmitting">⏳ Wird gesendet...</span>
        <span *ngIf="!isSubmitting && !allRequiredFieldsFilled()">⚠️ Pflichtfelder ({{ getRequiredFieldsStatus().filled }}/{{ getRequiredFieldsStatus().total }})</span>
      </button>
    </div>
  </div>
</div>
